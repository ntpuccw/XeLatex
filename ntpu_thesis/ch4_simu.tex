%\include{preamble}
%\title{第4章 \\ 模擬分析}
%\date{}
%\author{}
%\begin{document}
%\maketitle

\chapter{模擬分析}\label{ch:simu}
\noindent 本章將藉由不同的參數假設,模擬各種情境下之二元長期追蹤資料,以分析第~ \ref{ch:dist} ~章所提的多變量二元分配特性及其參數估計式表現;
及比較第~ \ref{ch:model} ~章所提的兩種平均反應模型之參數估計表現。此部份的數值分析係在各種參數假設下模擬 10,000 次,並比較以下四項指標:
\begin{enumerate}
  \item 平均值(Sampling Mean of Estimator):參數估計值之平均值,
  \item 估計式標準誤(Sampling Standard Error of Estimator, 簡稱 SSE):參數估計值之標準差,
  \item 平均標準誤(Sampling Mean of Standard Error of Estimator, 簡稱SEE):參數標準差估計值之平均值,
  \item 覆蓋率(Coverage Probability, 簡稱CP): 10,000 組隨機樣本參數估計結果之 95$\%$ 信賴區間包含真實參數比率。
\end{enumerate}
以下逐一說明模擬參數假設及其分析結果。

\section{多變量二元分配之模擬}\label{sec:simuDist}
本節假設重覆試驗次數增加為 5 次,以模擬各種長期追蹤資料試驗機率間可能存在的變化趨勢及試驗間關係,分析多變量二元分配之參數估計表現。
在重覆試驗次數 $k=5$ 時，多變量聯合機率質量函數可表示為
\[ f(y_1,\ldots,y_5) = p_1^{y_1} (1-p_1)^{1-y_1} \, \prod_{t=1}^{4} \, (\tilde{\mbox{P}}^{t,t+1}_{y_t,1})^{y_{t+1}} \, (1-\tilde{\mbox{P}}^{t,t+1}_{y_t,1})^{1-y_{t+1}},
\]
函數中參數包括各次試驗事件發生機率 $\bm{p}=(p_1,\,p_2,\,p_3,\,p_4,\,p_5)$, 及試驗間關係 $\bm{\rho}=(\rho_{12}, \rho_{23}, \rho_{34}, \rho_{45})$。

在說明模擬結果前,先在 $\bm{\rho}$ 與 $\bm{p}$ 是否相同兩大架構下,隨機產生幾組不同參數假設下的隨機樣本 ($n=100$), 以便了解模擬分析資料之特性,
但由於多變量資料無法以圖型呈現,故改為統計樣本資料所有可能試驗結果組合之次數分配。
亦即在重覆試驗次數 $k=5$ 的假設下,樣本值之所有可能組合共有 $2^5=32$ 種,在此記錄樣本資料中每一種可能試驗結果之發生人數,
並比較不同參數假設下次數分配的差異。表~ \ref{tab:r5sample} 為次數統計結果,表中參數設定如下:
\begin{enumerate}\label{r5t}
  \item 相同 $\bm{\rho}$, 不同 $\bm{p}$: 假設試驗間之相關係數相同, $\bm{\rho}=$ (0.5, 0.5, 0.5, 0.5), 觀察不同機率趨勢的影響,其中五組 $\bm{p}$ 值設定如下:
    \begin{description}
         \item [$A$]:相同, $\bm{p}=(0.3, 0.3, 0.3, 0.3, 0.3)$,
         \item [$B$]:遞增, $\bm{p}=(0.7, 0.75, 0.8, 0.85, 0.9)$,
         \item [$C$]:遞減, $\bm{p}=(0.8, 0.75, 0.7, 0.65, 0.6)$,
         \item [$D$]:先增後減 $\bm{p}=(0.4, 0.45, 0.5, 0.45, 0.4)$,
         \item [$E$]:先減後增, $\bm{p}=(0.6, 0.55, 0.5, 0.55, 0.6)$。
    \end{description}
  \item 相同 $\bm{p}$, 不同 $\bm{\rho}$: 假設事件發生機率相同, $\bm{p}=$ (0.3, 0.3, 0.3, 0.3, 0.3), 觀察各種試驗間相關係數大小的差異,其中四組 $\bm{\rho}$ 值設定如下:
     \begin{description}
         \item [$F$]:低, $\bm{\rho}=(0.4, 0.3, 0.2, 0.1)$,
         \item [$G$]:中, $\bm{\rho}=(0.65, 0.6, 0.55, 0.5)$,
         \item [$H$]:高, $\bm{\rho}=(0.85, 0.8, 0.75, 0.7)$,
         \item [$I$]:相同, $\bm{\rho}=(0.75, 0.75, 0.75, 0.75)$。
      \end{description}
   \end{enumerate}
以結果 1 為例, 5 個試驗時間點所關心之事件皆未發生的人數,在 100 個樣本資料中,假設試驗間之相關係數相同,機率變化趨勢假設為 $A$ 時有 36 人, $B$ 時有 2 人, $C$ 時有 2 人,
 $D$ 時有 22 人, $E$ 時有 8 人;假設機率相同,相關係數大小假設為 $F$ 時有 22 人, $G$ 時為 39 人,  $H$ 時為 43 人, $I$ 時為 52 人;其餘情況依此類推。

\begin{small}
\begin{threeparttable}[h]
    \centering
    \caption{重覆試驗次數 $k=5$, 假設 $\bm{\rho}=$ (0.5, 0.5, 0.5, 0.5) 在不同試驗機率趨勢下,及 $\bm{p}=$ (0.3, 0.3, 0.3, 0.3, 0.3) 在不同試驗間相關係數大小下,樣本資料於各種試驗結果可能值組合之人數統計 (樣本數為 100)。}
    \label{tab:r5sample}
    %\extrarowheight=0pt
    \tabcolsep=8pt
    \begin{tabular}{c|ccccc|ccccc|cccc}
    \hline
\multirow{3}{*}{結果}  &\multicolumn{5}{c|}{\multirow{2}{*}{試驗結果可能值}}  &\multicolumn{9}{c}{次數統計} \\[3pt]\cline{7-15}
                       &\multicolumn{5}{c|}{}                                 &\multicolumn{5}{c|}{相同 $\bm{\rho}$, 不同 $\bm{p}$\tnote{$\ast$}}\vline &\multicolumn{4}{c}{相同 $\bm{p}$, 不同 $\bm{\rho}$\tnote{$\ast$}} \\[2pt]\cline{2-15}
                       & $y_1$ &  $y_2$& $y_3$ & $y_4$ & $y_5$ &  $A$  & $B$   &  $C$  &  $D$ &  $E$ & $F$  &  $G$  &  $H$  &  $I$ \\[2pt]\hline
1   &   0   &   0   &   0   &   0   &   0   &   36  &   2   &   2   &   22  &   8   &   22  &   39  &   43  &   52  \\
2   &   0   &   0   &   0   &   0   &   1   &   11  &   2   &   2   &   5   &   5   &   9   &   10  &   5   &   5   \\
3   &   0   &   0   &   0   &   1   &   0   &   2   &   0   &   1   &   4   &   1   &   6   &   4   &   2   &   0   \\
4   &   0   &   0   &   0   &   1   &   1   &   4   &   6   &   3   &   5   &   7   &   4   &   5   &   4   &   3   \\
5   &   0   &   0   &   1   &   0   &   0   &   0   &   0   &   0   &   2   &   0   &   3   &   1   &   1   &   2   \\
6   &   0   &   0   &   1   &   0   &   1   &   0   &   1   &   0   &   0   &   0   &   3   &   1   &   0   &   0   \\
7   &   0   &   0   &   1   &   1   &   0   &   1   &   0   &   1   &   6   &   2   &   2   &   1   &   2   &   2   \\
8   &   0   &   0   &   1   &   1   &   1   &   2   &   6   &   4   &   5   &   6   &   2   &   4   &   2   &   7   \\
9   &   0   &   1   &   0   &   0   &   0   &   2   &   0   &   1   &   2   &   1   &   3   &   1   &   0   &   0   \\
10  &   0   &   1   &   0   &   0   &   1   &   0   &   0   &   0   &   1   &   0   &   3   &   0   &   0   &   0   \\
11  &   0   &   1   &   0   &   1   &   0   &   0   &   0   &   0   &   0   &   0   &   3   &   0   &   0   &   0   \\
12  &   0   &   1   &   0   &   1   &   1   &   1   &   0   &   0   &   2   &   1   &   0   &   0   &   0   &   0   \\
13  &   0   &   1   &   1   &   0   &   0   &   1   &   1   &   0   &   3   &   2   &   3   &   2   &   0   &   0   \\
14  &   0   &   1   &   1   &   0   &   1   &   0   &   0   &   0   &   1   &   0   &   1   &   1   &   0   &   0   \\
15  &   0   &   1   &   1   &   1   &   0   &   1   &   0   &   1   &   1   &   0   &   4   &   1   &   0   &   0   \\
16  &   0   &   1   &   1   &   1   &   1   &   6   &   16  &   3   &   3   &   6   &   2   &   2   &   1   &   4   \\
17  &   1   &   0   &   0   &   0   &   0   &   9   &   1   &   3   &   3   &   10  &   7   &   6   &   3   &   5   \\
18  &   1   &   0   &   0   &   0   &   1   &   0   &   1   &   1   &   1   &   4   &   0   &   2   &   1   &   0   \\
19  &   1   &   0   &   0   &   1   &   0   &   0   &   0   &   0   &   0   &   1   &   2   &   1   &   0   &   0   \\
20  &   1   &   0   &   0   &   1   &   1   &   0   &   1   &   1   &   0   &   4   &   1   &   0   &   1   &   1   \\
21  &   1   &   0   &   1   &   0   &   0   &   1   &   0   &   1   &   0   &   1   &   2   &   0   &   0   &   0   \\
22  &   1   &   0   &   1   &   0   &   1   &   0   &   1   &   0   &   0   &   0   &   0   &   0   &   0   &   0   \\
23  &   1   &   0   &   1   &   1   &   0   &   3   &   0   &   1   &   1   &   0   &   0   &   0   &   0   &   0   \\
24  &   1   &   0   &   1   &   1   &   1   &   0   &   2   &   2   &   0   &   3   &   1   &   0   &   0   &   0   \\
25  &   1   &   1   &   0   &   0   &   0   &   6   &   1   &   8   &   4   &   3   &   10  &   2   &   5   &   3   \\
26  &   1   &   1   &   0   &   0   &   1   &   2   &   3   &   3   &   2   &   2   &   1   &   0   &   0   &   1   \\
27  &   1   &   1   &   0   &   1   &   0   &   0   &   1   &   1   &   0   &   2   &   2   &   0   &   0   &   0   \\
28  &   1   &   1   &   0   &   1   &   1   &   0   &   2   &   6   &   0   &   4   &   1   &   0   &   1   &   0   \\
29  &   1   &   1   &   1   &   0   &   0   &   3   &   1   &   5   &   3   &   4   &   1   &   7   &   7   &   1   \\
30  &   1   &   1   &   1   &   0   &   1   &   1   &   1   &   1   &   1   &   2   &   0   &   1   &   0   &   0   \\
31  &   1   &   1   &   1   &   1   &   0   &   3   &   4   &   9   &   8   &   4   &   1   &   5   &   7   &   4   \\
32  &   1   &   1   &   1   &   1   &   1   &   5   &   47  &   40  &   15  &   17  &   1   &   4   &   15  &   10  \\\hline
\end{tabular}
\begin{tablenotes}\small
\item[$\ast$] 詳細設定請參考本文第 \pageref{r5t} 頁。
\end{tablenotes}
\end{threeparttable}
\end{small}

% Example: 1) 圖檔不是放在 graph 下時,先在全文設定區定義"impr"後,圖型插入的方式; 2)圖表標題太長時,換行的方式。
%\begin{figure}[H]
%    \centering
%      \subfloat[$\bm{\hat{p}}$]{\label{p}
%        \includegraphics[height=7cm,width=0.9\textwidth]{\impr{nBox_diffRho_equP_biasP.eps}}}\\
%     \subfloat[$\bm{\hat{\rho}}$]{\label{rho}
%        \includegraphics[height=7cm,width=0.9\textwidth]{\impr{nBox_diffRho_equP_biasRho.eps}}}
%    \caption{假設 $\bm{p}=$ (0.5, 0.5, 0.5, 0.5, 0.5)時,不同相關係數及樣本數假設下之參數估計偏誤。其中, $\rho$ equal 為 $\bm{\rho}=$ (0.5, 0.5, 0.5, 0.5),以實線表示; %
%             $\rho$ low 為 $\bm{\rho}=$ (0.4, 0.3, 0.2, 0.1),以點線表示; $\rho$ middle 為 $\bm{\rho}=$ (0.65, 0.6, 0.55, 0.5),以點虛線表示; %
%             $\rho$ high 為 $\bm{\rho}=$ (0.85, 0.8, 0.75, 0.7),以虛線表示。}
%    \label{fig:allk5epdr_bias}
%\end{figure}



\clearpage
\section{平均反應模型之模擬}\label{sec:simuMODEL}
\noindent 本節將藉由模擬不同型態的樣本資料,比較第~ \ref{ch:model} ~章所提的兩種平均反應模型參數估計方式,在不同的共變異數結構及樣本大小假設下之表現。
在此假設重覆試驗次數 $k=$ 5, 模擬產生來自以下兩種模型的資料:
\begin{enumerate}
  \item 情境一:本論文所提之平均反應模型如(\ref{equ:regf}),可表示為
    \begin{align*}
        \mbox{logit}\left[\mbox{E}(Y_{i,t+1}=1 \,|\,\bm{x}_{i,t+1},Y_{it}=y_{it})\right] &=\bm{x}'_{i,t+1}\bm{\beta}+\gamma_t\, y_{it},\;\;t=1,\cdots,4;
    \end{align*}
  \item 情境二:一般平均反應模型
    \begin{align*}
        \mbox{logit}\left[\mbox{E}(Y_{i,t+1}=1 \,|\,\bm{x}_{i,t+1})\right] &=\bm{x}'_{i,t+1}\bm{\beta},\;\;t=1,\cdots,4;
    \end{align*}
  \end{enumerate}
模型中解釋變數之設定包括連續型態的量測時間(T)及二元型態的試驗組別(G);其中,量測時間係以 0 代表第一次量測,可能值為 0-4,
並假設解釋變數間存在交互作用(Interaction),故解釋變數之線性模型為
\begin{align*}
   \bm{x}'_{i,t+1}\bm{\beta} &=\beta_1 + \beta_2\, \mbox{G}_i + \beta_3\, \mbox{T}_{i,t+1} + \beta_4 \,\mbox{G}_i \times \mbox{T}_{i,t+1},   \\
                             &\qquad\qquad\qquad\qquad\qquad i=1,\cdots,n,\; t=1,\cdots,4;
\end{align*}
其中, $\beta_1$ 為截距項(Intercept),參數 $\bm{\beta}$ 的模擬設定為 $(\beta_1, \beta_2, \beta_3, \beta_4)=$ (-1.23, 0.14, 0.5, 1.2)。

本論文建構在多變量二元分配假設下之邊際模型係藉由參數 $\bm{\gamma}$ 來衡量同一研究對象各次試驗結果間可能存在之關聯,
故模型中參數除了 $\bm{\beta}$ 外,還有 $\bm{\gamma}$ 的部分;兩者皆以最大概似估計法進行參數估計,並利用 \ref{sec:mle} 節所列示之最大概似函數二階微分結果計算觀
測的費雪訊息矩陣之反矩陣,作為參數估計值的漸近共變異數矩陣,並以 $\Sigma_{FI}$ 表示。
而以 GEE 進行參數估計之邊際模型則是藉由不同的工作矩陣假設來將上述個體內關聯納入考量,本論文以 $\bm{\lambda}$ 表示,矩陣中參數個數與共變異數結構假設有關;
此節模擬以對數勝算比方式來設定工作矩陣,矩陣型態包括試驗時間點之間的共變異數相同、 Toeplitz 及無結構三種,並分別以 $\Sigma_{GE}$、 $\Sigma_{GT}$ 及 $\Sigma_{GF}$ 表示,
以 GEE 進行參數估計之模擬,係藉由 SAS 中的 GENMOD 程序,而 MLE 則藉由 MATLAB 的 FMINSEARCH 函數 (Lagarias, Reeds, Wright and Wright, 1998) 計算 MLE。

首先,以 $\bm{\gamma}=$ (0.3, 0.25, 0.2, 0.15),  $n=$ 250 為例,比較各種方法之估計結果,表 \ref{tab:est_sd250} 為此情境下各種方法解釋變數參數模擬結果。
其中,平均值為 10,000 組隨機樣本參數估計值之平均值; SSE 為 10,000 組隨機樣本參數估計值之標準差; SEE 為 10,000 組隨機樣本參數標準差之平均值;
CP 為 10,000 組參數估計結果之 95$\%$ 信賴區間包含真實參數比率。
比較表 \ref{tab:est_sd250} 中之 SSE 及 SEE 可知,四種參數估計方式的 SSE 差異不大,
彼此差距在小數位第 3 位;而 $\Sigma_{FI}$ 的 SEE 是四種方法中最小的,但 SEE 與 SSE 差距為最大,故其 CP 表現較差。

\begin{table}[hbt]
    \centering
    \extrarowheight=2pt
    \caption{假設 $\bm{\gamma}=$ (0.3, 0.25, 0.2, 0.15), $n=$ 250 時,各種方法之平均反應模型解釋變數參數估計結果比較。}\label{tab:est_sd250}
    \begin{tabular}{ccc|cccc}
    \toprule
\multirow{2}{*}{參數}   &\multirow{2}{*}{真實值}  &估計   & MLE              &   \multicolumn{3}{c}{GEE}         \\\cline{5-7}
                        &                         &指標   & $\Sigma_{FI}$    & $\Sigma_{GE}$    & $\Sigma_{GT}$    &  $\Sigma_{GF}$    \\[3pt]\hline
$\hat{\beta}_1$   &   -1.23   &   平均值  &   -1.2376 &   -1.2041 &   -1.2049 &   -1.2052 \\
 (截距項)   &       &   SSE &   0.1667  &   0.1631  &   0.1633  &   0.1643  \\
            &       &   SEE &   0.0711  &   0.1610  &   0.1607  &   0.1599  \\
            &       &   CP  &   0.6058  &   0.9414  &   0.9412  &   0.9382  \\
$\hat{\beta}_2$   &   0.14    &   平均值  &   0.1315  &   0.1058  &   0.1067  &   0.1070  \\
(G)         &       &   SSE &   0.2451  &   0.2484  &   0.2486  &   0.2493  \\
            &       &   SEE &   0.1272  &   0.2469  &   0.2467  &   0.2460  \\
            &       &   CP  &   0.6911  &   0.9487  &   0.9474  &   0.9460  \\
$\hat{\beta}_3$   &   0.50    &   平均值  &   0.5056  &   0.5213  &   0.5215  &   0.5216  \\
(T)         &       &   SSE &   0.0790  &   0.0654  &   0.0655  &   0.0659  \\
            &       &   SEE &   0.0330  &   0.0644  &   0.0643  &   0.0639  \\
            &       &   CP  &   0.5972  &   0.9390  &   0.9373  &   0.9344  \\
$\hat{\beta}_4$   &   1.20    &   平均值  &   1.2249  &   1.2671  &   1.2669  &   1.2667  \\
(T $\times$ G)  &       &   SSE &   0.1799  &   0.1760  &   0.1761  &   0.1764  \\
            &       &   SEE &   0.1093  &   0.1706  &   0.1705  &   0.1702  \\
            &       &   CP  &   0.7720  &   0.9386  &   0.9397  &   0.9382  \\
    \bottomrule
    \end{tabular}
\end{table}






%\end{document}


